---

- name: Gather facts from all hosts
  hosts: all
  become: true
  gather_facts: true
  tags: always

- name: Create jobs on Director for every client in host_group filedaemons
  hosts: directors
  become: true
  vars:
    _job_list: []
  pre_tasks:
    - name: Create job list for all FDs with defined standard values (group_vars)
      ansible.builtin.set_fact:
        _job_list: >-
          {{ _job_list + [{
            'name': job_defaults.name+'_'+item,
            'client': item,
            'pool': job_defaults.pool,
            'type': job_defaults.type,
            'messages': job_defaults.messages,
            'jobdefs': job_defaults.jobdefs,
            'storage': job_defaults.storage,
            'schedule': job_defaults.schedule}]
          }}
      loop: "{{ groups['filedaemons'] }}"
      tags: manage_jobs
      when:
        - ansible_limit is undefined or
          item in groups[ansible_limit]  # only use filedaemons in-scope of --limit/-l
        - hostvars[item].bareos_fd_jobs is undefined  # let's you set exceptions on group/host_vars level

    - name: Add dedicated jobs defined in host_vars
      ansible.builtin.set_fact:
        _job_list: >-
          {{ _job_list + hostvars[item].bareos_fd_jobs }}
      loop: "{{ groups['filedaemons'] }}"
      tags: manage_jobs
      when:
        - ansible_limit is undefined or
          item in groups[ansible_limit]  # only use filedaemons in-scope of --limit/-l
        - hostvars[item].bareos_fd_jobs is undefined  # let's you set exceptions on group/host_vars level

    - name: Register job list
      ansible.builtin.set_fact:
        bareos_dir_jobs: "{{ _job_list }}"
      tags: manage_jobs

  roles:
    - role: bareos_dir
      tags: manage_jobs
